<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªç„¶æ‹¼è¯» Pro - V20 å€ªç®è±</title>
    <!-- å¼•å…¥ Mammoth ç”¨äºè§£æ Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <!-- å¼•å…¥åœ†æ¶¦å¯çˆ±çš„è‹±æ–‡å­—ä½“ Quicksand -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #7b61ff;
            --success: #52c41a;
            --success-bg: #d9f7be;
            --danger: #ff4d4f;
            --bg: #f5f7fa; 
            --font-main: 'Quicksand', 'Comic Sans MS', 'Segoe UI Rounded', sans-serif;
            --font-mono: "Consolas", "Monaco", monospace; 
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg); 
            margin: 0; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; 
            transition: background-color 0.5s ease;
        }

        .view-section { display: none; height: 100%; width: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .dashboard-container { padding: 40px; max-width: 1000px; margin: 0 auto; width: 100%; overflow-y: auto; }
        
        .key-hint { display: inline-block; padding: 2px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; color: #999; margin-left: 5px; background: #fff; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-num { font-size: 40px; font-weight: 800; color: var(--primary); display: block; margin-bottom: 5px; }
        .stat-label { color: #888; font-size: 14px; font-weight: 600; }

        /* æŒ‰é’® */
        .menu-btn { font-family: var(--font-main); font-size: 18px; padding: 15px 40px; border-radius: 50px; border: none; cursor: pointer; font-weight: 700; margin: 0 10px; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .menu-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); color: white; }
        
        .header { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; height: 60px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .step-indicators { display: flex; gap: 40px; }
        .step-ind { font-size: 22px; color: #ddd; font-weight: bold; transition: 0.3s; }
        .step-ind.active { color: var(--primary); transform: scale(1.1); text-shadow: 0 2px 5px rgba(123,97,255,0.2); }
        
        /* èˆå° */
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; gap: 40px; }
        .instruction { font-size: 28px; color: #888; font-weight: 600; margin-top: 20px; opacity: 0.8; }

        /* æ¢è‚¤æ§ä»¶ */
        .theme-selector { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; background: rgba(255,255,255,0.6); padding: 10px; border-radius: 30px; width: fit-content; margin-left: auto; margin-right: auto; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { border-color: #333; }

        /* è¾“å…¥æ¡†ä¸è§†è§‰å±‚ */
        .rich-input-wrapper { 
            position: relative; display: inline-block; margin: 0 10px; 
            background: white; 
            border-radius: 20px; border: 5px solid #e0e0e0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); cursor: text;
            transition: all 0.2s;
        }
        .visual-layer { 
            font-family: var(--font-main); font-size: 80px; font-weight: 800; 
            text-align: center; width: 100%; height: 100%; line-height: 160px; 
            position: absolute; top: 0; left: 0; z-index: 1;
            pointer-events: none; white-space: pre;
            background: transparent !important; 
        }
        .ghost-input { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; 
            opacity: 0 !important; cursor: text; padding: 0; margin: 0; border: none;
        }
        .cursor {
            display: inline-block; width: 5px; height: 70px; background-color: #333; border-radius: 3px;
            vertical-align: middle; margin-bottom: 12px; animation: blink 1s step-end infinite;
        }
        .ghost-input:not(:focus) + .visual-layer .cursor { display: none; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .rich-input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 6px rgba(123,97,255,0.2); }
        
        .rich-input-wrapper.correct { 
            border-color: var(--success) !important; 
            background-color: var(--success-bg) !important; 
            box-shadow: 0 0 30px rgba(82, 196, 26, 0.4) !important;
            transform: scale(1.05); 
        }
        .rich-input-wrapper.correct .c { color: #0050b3; } 
        .rich-input-wrapper.correct .v { color: #cf1322; }
        .rich-input-wrapper.error { border-color: var(--danger); animation: shake 0.4s; }
        .v { color: #ff4d4f; font-weight: 900; } 
        .c { color: #1890ff; } 
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }
        
        .enter-tip { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); color: #aaa; font-size: 16px; opacity: 0; transition: 0.3s; font-weight: bold; }
        .enter-tip.show { opacity: 1; }
        
        .summary-card { background: white; padding: 50px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.1); animation: popIn 0.5s; }
        @keyframes popIn { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }

        .drop-zone { border: 3px dashed #ccc; padding: 60px; background: white; border-radius: 20px; margin: 20px auto; max-width: 600px; cursor: pointer; text-align: center; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--primary); background: #f9f9ff; }

        .data-management { margin-top: 50px; padding-top: 30px; border-top: 2px dashed #e0e0e0; text-align: center; color: #666; }
        .data-btn { background: white; border: 1px solid #ccc; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin: 5px 10px; font-family: var(--font-main); font-weight: 600; color: #555; transition: all 0.2s; }
        .data-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .btn-reset { border-color: #ffccc7; color: var(--danger); }
        .btn-reset:hover { background: var(--danger); color: white; border-color: var(--danger); }
    </style>
</head>
<body>

    <div id="view-dashboard" class="view-section active">
        <div class="dashboard-container">
            <h1 style="text-align:center; color:#333; font-size: 48px; margin-bottom: 10px;">ğŸ“š å€ªç®è± è‡ªç„¶æ‹¼è¯» V20</h1>
            <p style="text-align:center; color:#888; margin-bottom: 30px;">ä»Šæ—¥ç›®æ ‡ï¼š<b id="daily-target" style="color:var(--primary)">0</b> è¯</p>
            
            <div class="theme-selector">
                <div class="color-dot active" style="background:#f5f7fa" onclick="App.setTheme('#f5f7fa', this)" title="æŠ¤çœ¼è“"></div>
                <div class="color-dot" style="background:#f3e8ff" onclick="App.setTheme('#f3e8ff', this)" title="æ·¡é›…ç´«"></div>
                <div class="color-dot" style="background:#fff0f6" onclick="App.setTheme('#fff0f6', this)" title="æ¨±èŠ±ç²‰"></div>
                <div class="color-dot" style="background:#e6fffb" onclick="App.setTheme('#e6fffb', this)" title="è–„è·ç»¿"></div>
                <div class="color-dot" style="background:#fff7e6" onclick="App.setTheme('#fff7e6', this)" title="æš–ç±³è‰²"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><span class="stat-num" id="stat-total">0</span><span class="stat-label">æ€»è¯åº“</span></div>
                <div class="stat-card"><span class="stat-num" id="stat-learned" style="color:var(--success)">0</span><span class="stat-label">å·²æŒæ¡</span></div>
                <div class="stat-card"><span class="stat-num" id="stat-remain" style="color:#faad14">0</span><span class="stat-label">æœªå­¦ä¹ </span></div>
                <div class="stat-card"><span class="stat-num" id="stat-mistakes" style="color:var(--danger)">0</span><span class="stat-label">å¾…çº é”™</span></div>
            </div>
            
            <div style="text-align:center; margin-bottom:30px;">
                <label style="font-weight:bold; color:#555;">è®¡åˆ’å¤©æ•°ï¼š<input type="number" id="plan-days" value="21" style="width:60px;text-align:center; border-radius:10px; border:1px solid #ccc; padding:5px;" onchange="App.saveConfig()"></label>
                &nbsp;&nbsp;
                <select id="learn-order" style="padding:5px; border-radius:10px; border:1px solid #ccc; font-weight:bold; color:#555;">
                    <option value="random">ğŸ² éšæœºä¹±åº</option>
                    <option value="sequence">ğŸ”¢ åˆ—è¡¨é¡ºåº</option>
                </select>
            </div>
            
            <div style="text-align:center;">
                <button class="menu-btn btn-primary" onclick="App.start('daily')">ğŸš€ å¼€å§‹ç»ƒä¹  <span class="key-hint">Enter</span></button>
                <button class="menu-btn" style="color:var(--danger); border:2px solid var(--danger); background:white;" onclick="App.start('review')">ğŸ’Š å¤ä¹ é”™é¢˜</button>
                <button class="menu-btn" style="border:2px solid #ddd; background:white;" onclick="App.switchView('import')">ğŸ“‚ å¯¼å…¥æ–°è¯</button>
            </div>

            <div class="data-management">
                <button class="data-btn" onclick="DataManager.exportData()">â¬‡ï¸ å¤‡ä»½è¿›åº¦</button>
                <button class="data-btn" onclick="document.getElementById('backup-input').click()">â¬†ï¸ æ¢å¤è¿›åº¦</button>
                <button class="data-btn" style="border-color:var(--primary); color:var(--primary)" onclick="DataManager.exportMistakesTxt()">ğŸ“„ å¯¼å‡ºé”™é¢˜æœ¬(TXT)</button>
                <button class="data-btn btn-reset" onclick="DataManager.resetData()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
                <input type="file" id="backup-input" hidden accept=".json" onchange="DataManager.importData(this.files[0])">
            </div>
        </div>
    </div>

    <div id="view-import" class="view-section">
        <div class="dashboard-container">
            <h2 style="text-align:center">å¯¼å…¥æ–°å•è¯</h2>
            <div class="drop-zone" onclick="document.getElementById('file-input').click()">
                <div style="font-size:40px">ğŸ“„</div>
                <div>ç‚¹å‡»ä¸Šä¼  Word / Txt</div>
                <div id="file-name" style="color:var(--primary); margin-top:10px; font-weight:bold;"></div>
            </div>
            <input type="file" id="file-input" hidden accept=".docx,.txt" onchange="Importer.handleFile(this.files[0])">
            <textarea id="manual-text" placeholder="æ ¼å¼ç¤ºä¾‹ï¼š&#10;handsome hand/some è‹±ä¿Šçš„&#10;apple è‹¹æœ" style="width:100%; height:150px; margin:20px 0; padding:15px; font-family: monospace; border-radius:15px; border:2px solid #eee;"></textarea>
            <div style="text-align:center;">
                <button class="menu-btn btn-primary" onclick="Importer.parseManual()">ç¡®å®šå¯¼å…¥</button>
                <button class="menu-btn" onclick="App.switchView('dashboard')">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    </div>

    <div id="view-practice" class="view-section">
        <div class="header">
            <button onclick="App.endSession()" style="padding:8px 20px; cursor:pointer; border-radius:20px; border:1px solid #ddd; background:white; font-weight:bold; color:#666;">Esc é€€å‡º</button>
            <div class="step-indicators">
                <div id="ind-1" class="step-ind">1. è¯»</div>
                <div id="ind-2" class="step-ind">2. åˆ†</div>
                <div id="ind-3" class="step-ind">3. å†™</div>
            </div>
            <div style="font-weight:bold; color:#888;">å‰©ä½™: <b id="remain-count">0</b></div>
        </div>
        <div class="stage" id="stage"></div>
        <div id="enter-tip" class="enter-tip">æŒ‰ Enter ä¸‹ä¸€æ­¥</div>
    </div>

    <script>
        const DB = {
            key: 'phonics_pro_v20_npx',
            data: { lib: [], config: { planDays: 21, bgColor: '#f5f7fa' } },
            load() { 
                const r = localStorage.getItem(this.key); 
                if(r) {
                    this.data = JSON.parse(r);
                    if(!this.data.config) this.data.config = { planDays: 21, bgColor: '#f5f7fa' };
                }
            },
            save() { localStorage.setItem(this.key, JSON.stringify(this.data)); App.updateUI(); },
            add(list) {
                let c = 0;
                list.forEach(i => {
                    if(!this.data.lib.find(w=>w.word===i.word)) {
                        // çº¯å‡€æ¨¡å¼ï¼šæ²¡æœ‰é»˜è®¤è¯åº“ï¼Œåªç”¨å¯¼å…¥çš„ç¿»è¯‘
                        let trans = i.trans || "æš‚æ— é‡Šä¹‰";
                        const finalChunks = i.chunks || this.split(i.word);
                        this.data.lib.push({ 
                            word: i.word, 
                            trans: trans, 
                            chunks: finalChunks, 
                            status: 0, 
                            err: 0, 
                            allTimeErr: 0
                        });
                        c++;
                    }
                });
                alert(`å¯¼å…¥ ${c} è¯`); this.save();
            },
            split(w) { return w.length<=4 ? [w] : (w.toLowerCase().match(/[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi) || [w]); }
        };

        const DataManager = {
            exportData() {
                const blob = new Blob([JSON.stringify(DB.data)], {type: "application/json"});
                this.download(blob, `phonics_full_backup.json`);
            },
            exportMistakesTxt() {
                const mistakes = DB.data.lib.filter(w => (w.allTimeErr || 0) > 0);
                if(mistakes.length === 0) return alert("ğŸ‘ ç›®å‰æ²¡æœ‰å†å²é”™é¢˜è®°å½•ã€‚");
                const txtContent = mistakes.map(item => `${item.word} ${item.chunks.join('/')} ${item.trans}`).join('\n');
                const blob = new Blob([txtContent], {type: "text/plain"});
                this.download(blob, `wrong_words_list.txt`);
            },
            download(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                URL.revokeObjectURL(url);
            },
            importData(file) {
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const newData = JSON.parse(e.target.result);
                        if(newData.lib) { DB.data = newData; DB.save(); alert("âœ… æ¢å¤æˆåŠŸ"); }
                    } catch(e) { alert("âŒ æ–‡ä»¶é”™è¯¯"); }
                    document.getElementById('backup-input').value = '';
                };
                reader.readAsText(file);
            },
            resetData() {
                if(confirm("âš ï¸ è­¦å‘Šï¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")) { localStorage.removeItem(DB.key); location.reload(); }
            }
        };

        const Importer = {
            handleFile(f) {
                if(!f) return; document.getElementById('file-name').innerText = f.name;
                const r = new FileReader();
                if(f.name.endsWith('.docx')) r.onload = e => mammoth.extractRawText({arrayBuffer:e.target.result}).then(x=>this.parse(x.value));
                else r.onload = e => this.parse(e.target.result);
                f.name.endsWith('.docx') ? r.readAsArrayBuffer(f) : r.readAsText(f);
            },
            parseManual() { this.parse(document.getElementById('manual-text').value); },
            parse(txt) {
                const list = [];
                const lines = txt.split(/[\r\n]+/);
                lines.forEach(line => {
                    const parts = line.trim().split(/\s+/);
                    if(parts.length===0 || parts[0]==="") return;
                    let word="", chunks=null, trans="";
                    const splitPart = parts.find(p => p.includes('/'));
                    if(splitPart) {
                        chunks = splitPart.split('/').map(c=>c.toLowerCase());
                        word = chunks.join('');
                        trans = parts.filter(p=>p!==splitPart && p.toLowerCase()!==word).join(' ');
                    } else {
                        if(/[a-zA-Z]/.test(parts[0])) {
                            word = parts[0].toLowerCase();
                            trans = parts.slice(1).join(' ');
                        }
                    }
                    if(word) list.push({word, chunks, trans});
                });
                if(list.length) { DB.add(list); App.switchView('dashboard'); } else alert("æ— æœ‰æ•ˆå†…å®¹");
            }
        };

        const Practice = {
            queue: [], idx: 0, step: 1, canNext: false, mode: 'learning', currentWordHasError: false,
            start(list, mode) {
                this.queue = list; this.idx = 0; this.mode = mode;
                this.loadWord(0); document.addEventListener('keydown', this.handleKey);
            },
            stop() { document.removeEventListener('keydown', this.handleKey); App.switchView('dashboard'); },
            handleKey(e) {
                if(e.key === 'Escape') { App.endSession(); return; }
                if(Practice.mode === 'summary' && e.key === 'Enter') { Practice.stop(); return; }
                if(Practice.mode !== 'summary' && e.key === 'Enter') { if(Practice.canNext) Practice.next(); }
            },
            loadWord(i) {
                this.idx = i; this.step = 1; this.canNext = false; this.currentWordHasError = false;
                document.getElementById('remain-count').innerText = this.queue.length - i;
                this.render();
            },
            setCanNext(b) { this.canNext = b; document.getElementById('enter-tip').classList.toggle('show', b); },

            render() {
                const data = this.queue[this.idx];
                const stage = document.getElementById('stage');
                stage.innerHTML = '';
                [1,2,3].forEach(n => document.getElementById(`ind-${n}`).className = `step-ind ${n===this.step?'active':''}`);

                if(this.step === 1) {
                    this.setCanNext(true);
                    const wordBox = document.createElement('div');
                    wordBox.style.display = 'flex'; wordBox.style.gap = '15px';
                    wordBox.innerHTML = data.chunks.map(c=>
                        `<div class="rich-input-wrapper" style="width:${Math.max(120, c.length*70)}px; height:160px; border-color:var(--primary);">
                            <div class="visual-layer" style="line-height:160px;">${this.color(c)}</div>
                         </div>`
                    ).join('');
                    stage.appendChild(wordBox);
                    const transBox = document.createElement('div');
                    transBox.className = 'instruction'; transBox.innerText = data.trans || "";
                    stage.appendChild(transBox);
                    setTimeout(() => this.speak(data.word), 100);
                }
                else if(this.step === 2) {
                    this.setCanNext(false);
                    const container = document.createElement('div');
                    container.style.display='flex'; container.style.alignItems='center';
                    data.chunks.forEach((chunk, k) => {
                        if(k>0) {
                            const sep = document.createElement('div'); sep.innerHTML = '-'; 
                            sep.style.fontSize='40px'; sep.style.color='#ccc'; sep.style.margin='0 10px';
                            container.appendChild(sep);
                        }
                        const {wrapper, input} = this.createGhostInput(chunk.length, `seg-${k}`);
                        input.disabled = (k!==0);
                        input.addEventListener('input', () => {
                            if(input.value.toLowerCase() === chunk) {
                                wrapper.classList.add('correct'); input.disabled=true;
                                const next = document.getElementById(`seg-${k+1}`);
                                if(next) { next.disabled=false; next.focus(); this.speak(data.chunks[k+1], true); }
                                else { this.setCanNext(true); this.speak('Good'); }
                            } else if(input.value.length >= chunk.length) { this.triggerError(wrapper); }
                        });
                        input.addEventListener('keydown', e => { if(e.key==='Enter') e.preventDefault(); });
                        container.appendChild(wrapper);
                    });
                    stage.appendChild(container);
                    const label = document.createElement('div'); label.className = 'instruction'; label.innerText = "åˆ†æ®µæ‹¼å†™"; stage.appendChild(label);
                    setTimeout(() => { const f = document.getElementById('seg-0'); if(f) f.focus(); this.speak(data.chunks[0], true); }, 100);
                }
                else if(this.step === 3) {
                    this.setCanNext(false);
                    const {wrapper, input} = this.createGhostInput(data.word.length, 'full');
                    wrapper.style.width = '700px'; 
                    input.addEventListener('keydown', e => {
                        if(e.key === 'Enter') {
                            e.stopPropagation();
                            if(this.canNext) { Practice.next(); return; }
                            if(input.value.toLowerCase() === data.word) {
                                wrapper.classList.add('correct'); input.disabled=true;
                                this.saveResult(data); 
                                this.speak('Excellent');
                                this.setCanNext(true);
                            } else { this.triggerError(wrapper); }
                        }
                    });
                    stage.appendChild(wrapper);
                    const label = document.createElement('div'); label.className = 'instruction'; label.innerText = "å¬éŸ³é»˜å†™"; stage.appendChild(label);
                    setTimeout(() => { input.focus(); this.speak(data.word); }, 100);
                }
            },

            createGhostInput(len, id) {
                const w = document.createElement('div'); w.className = 'rich-input-wrapper';
                w.style.width = Math.max(140, len * 70) + 'px'; w.style.height = '160px';
                const inp = document.createElement('input'); inp.className = 'ghost-input';
                inp.maxLength = len; inp.id = id; inp.autocomplete = "off";
                const vis = document.createElement('div'); vis.className = 'visual-layer';
                vis.innerHTML = `<span class="cursor"></span>`;
                inp.addEventListener('input', () => {
                    let html = this.color(inp.value);
                    if (inp.value.length < len) html += `<span class="cursor"></span>`;
                    vis.innerHTML = html;
                });
                w.append(inp, vis);
                return {wrapper:w, input:inp};
            },

            triggerError(wrapper) {
                wrapper.classList.add('error'); this.speak('Try again');
                this.currentWordHasError = true; 
                const dbItem = DB.data.lib.find(w => w.word === this.queue[this.idx].word);
                if(dbItem) {
                    dbItem.err++; 
                    if(!dbItem.allTimeErr) dbItem.allTimeErr = 0;
                    dbItem.allTimeErr++;
                }
                DB.save();
                setTimeout(() => { this.step = 1; this.render(); }, 1000);
            },

            saveResult(data) {
                const dbItem = DB.data.lib.find(w => w.word === data.word);
                if(!dbItem) return;
                if (this.mode === 'review' && !this.currentWordHasError) {
                    if(dbItem.err > 0) dbItem.err--;
                }
                dbItem.status = 1; 
                DB.save();
            },

            next() {
                if(this.step < 3) { this.step++; this.render(); }
                else { if(this.idx < this.queue.length-1) this.loadWord(this.idx+1); else this.showSummary(); }
            },
            showSummary() {
                this.mode = 'summary';
                document.getElementById('stage').innerHTML = `<div class="summary-card"><h1>ğŸ‰ å®Œæˆ</h1><p style="color:#999">æŒ‰ Enter è¿”å›</p></div>`;
                this.setCanNext(false);
            },
            color(t) { return t ? t.split('').map(c=>`<span class="${/[aeiouy]/i.test(c)?'v':'c'}">${c}</span>`).join('') : ''; },
            
            speak(t, isChunk = false) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(t);
                u.lang = 'en-US';
                const voices = window.speechSynthesis.getVoices();
                const betterVoice = voices.find(v => v.name.includes("Google US")) || voices.find(v => v.name.includes("Zira"));
                if(betterVoice) u.voice = betterVoice;
                u.rate = isChunk ? 0.8 : 1.0;
                window.speechSynthesis.speak(u); 
            }
        };

        const App = {
            init() { 
                DB.load(); 
                this.applyTheme(DB.data.config.bgColor || '#f5f7fa'); 
                this.updateUI(); 
                document.addEventListener('keydown', (e) => {
                    if(document.getElementById('view-dashboard').classList.contains('active') && e.key === 'Enter') { App.start('daily'); }
                });
            },
            setTheme(color, el) {
                this.applyTheme(color);
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
                DB.data.config.bgColor = color;
                DB.save();
            },
            applyTheme(color) {
                document.body.style.backgroundColor = color;
            },
            switchView(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); this.updateUI(); },
            updateUI() {
                const l = DB.data.lib;
                document.getElementById('stat-total').innerText = l.length;
                document.getElementById('stat-learned').innerText = l.filter(w=>w.status==1).length;
                document.getElementById('stat-remain').innerText = l.filter(w=>w.status==0).length;
                document.getElementById('stat-mistakes').innerText = l.filter(w=>w.err>0).length;
                document.getElementById('daily-target').innerText = Math.ceil(l.filter(w=>w.status==0).length / DB.data.config.planDays) || 0;
            },
            saveConfig() { DB.data.config.planDays = document.getElementById('plan-days').value; DB.save(); },
            start(mode) {
                const l = DB.data.lib;
                let list = [];
                if(mode==='daily') {
                    let pool = l.filter(w=>w.status==0);
                    if(pool.length === 0) {
                        if(confirm("æ–°è¯å·²å­¦å®Œï¼æ˜¯å¦å¤ä¹ å·²å­¦å•è¯ï¼Ÿ")) pool = l.filter(w=>w.status==1);
                        else return;
                    }
                    const c = parseInt(document.getElementById('daily-target').innerText) || 10;
                    const rnd = document.getElementById('learn-order').value==='random';
                    list = rnd ? pool.sort(()=>0.5-Math.random()).slice(0,c) : pool.slice(0,c);
                } else {
                    list = l.filter(w=>w.err>0); 
                    if(!list.length) return alert("å¤ªæ£’äº†ï¼å¾ªç¯é”™é¢˜å·²å…¨éƒ¨æ¶ˆç­ã€‚\n\n(å†å²é”™é¢˜å¯å¯¼å‡ºTXTå¤ä¹ )");
                }
                App.switchView('practice'); Practice.start(list, mode);
            },
            endSession() { if(confirm("é€€å‡º?")) { Practice.stop(); App.switchView('dashboard'); } }
        };
        App.init();
    </script>
</body>
</html>
